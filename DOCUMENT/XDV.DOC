

MFXDDN driver technical manual                                   ver.1.15DOC



mfxddn.doc
----------------------------------------------------------------------------
DOS汎用音源ドライバ
                           MFXDRV/DDN version 1.15
                    XDVドライバ作成方法及び仕様についての
                            テクニカルマニュアル
            copyright (c) 1993-95 by T.Kobayashi / Interfair(DIL)
                            All Rights Reserved.

----------------------------------------------------------------------------






                                 第1章  はじめに



      この度は、 Interfair製MFXDRV/DDNシステムテクニカルドキュメントをダウン
    ロード頂き誠にありがとうございましたm(__)m。

      MFXDRV/DDN Kernel(以下DDN)は、音源やタイマなどを制御するとき組み込まれ
    たドライバを介して、目的の装置をアクセスします。本マニュアルは、各装置を
    実際にアクセスするドライバ(XDV)の作り方や、構造等を解説するﾂﾓﾘです(笑)。
    (ということで、一般ユーザには関係ないものかも:-)。






                        第2章  xdvファイルのフォーマット


      DDN専用のドライバプログラム(XDV)は、 COM形式のファイルであり、先頭の固
    定ヘッダに、DRVIDや、実行アドレス等が格納されています。さて、 以下の表の
    アドレスとは、 COMファイルがメモリ配置される実際のオフセット番地であり、
    ファイルの先頭から100hということではありません(つまり 100H  というのは、
    ファイルの先頭ってことです)。

+-------------------------------------------------------------------------+
|address   |size      |abbreviation        |explanation                   |
|----------+----------+--------------------+------------------------------|
|100h      |byte(4)   |jmp near ...        |comファイルとしてコマンドライ |
|          |          |                    |ンから実行したときに実行する、|
|          |          |                    |ジャンプ命令です。            |
|----------+----------+--------------------+------------------------------|
|104h      |word      |DRVTYPE             |ドライバの種別を表します。    |
|          |          |                    |  0000h...音源ドライバ        |
|          |          |                    |  1000h...タイマドライバ      |
|          |          |                    |  2000h...その他ドライバ      |
|----------+----------+--------------------+------------------------------|
|106h      |asciiz(16)|DRVID               |ドライバの名前を格納します。  |


                                   - 1 -                             DIL1995




MFXDDN driver technical manual                                   ver.1.15DOC


|          |          |                    |15byteで名前本体を記述し、    |
|          |          |                    |16byte目にNULL(00h)を設定しま |
|          |          |                    |す。名前が15文字未満の場合、の|
|          |          |                    |こりの空き部分はSPACE(20h)で埋|
|          |          |                    |めます。                      |
|----------+----------+--------------------+------------------------------|
|116h      |word      |DRVINIT             |mld.exe等でドライバを読み込ん |
|          |          |                    |だとき実行するプログラムのアド|
|          |          |                    |レスを格納するところです。プロ|
|          |          |                    |グラムは、far callで呼び出され|
|          |          |                    |るので、far ret で戻る必要があ|
|          |          |                    |ります。                      |
|----------+----------+--------------------+------------------------------|
|118h      |word      |DRVEND              |MFXDRV/DDN解放時に実行するプロ|
|          |          |                    |グラムのアドレスを格納するとこ|
|          |          |                    |ろです。プログラムの呼び出し方|
|          |          |                    |法は、DRVINITと同じです。     |
|----------+----------+--------------------+------------------------------|
|11ah      |word      |DRVPLAY             |演奏開始時に実行するプログラム|
|          |          |                    |のアドレスを格納するところで  |
|          |          |                    |す。  プログラムの呼び出し方法|
|          |          |                    |は、DRVINITと同じです。       |
|----------+----------+--------------------+------------------------------|
|11ch      |word      |DRVSTOP             |演奏終了時に実行するプログラム|
|          |          |                    |のアドレスを格納するところで  |
|          |          |                    |す。  プログラムの呼び出し方法|
|          |          |                    |は、DRVINITと同じです。       |
|----------+----------+--------------------+------------------------------|
|11eh      |word      |DRVINT              |演奏中、 1クロック毎に常に呼び|
|          |          |                    |出されるプログラムのアドレスを|
|          |          |                    |格納するところです。プログラム|
|          |          |                    |の呼び出し方法は、 DRVINITと同|
|          |          |                    |じです。                      |
|----------+----------+--------------------+------------------------------|
|120h      |byte      |DRVCH               |使用可能チャンネル数          |
|----------+----------+--------------------+------------------------------|
|121h      |byte      |DRVUSECH            |使用中チャンネル数            |
|----------+----------+--------------------+------------------------------|
|122h      |byte      |DRVVERINT           |ドライバのVersionの整数部。   |
|          |          |                    |Version 1.05 なら、10進の1を格|
|          |          |                    |納する。                      |
|----------+----------+--------------------+------------------------------|
|123h      |byte      |DRVVERREAL          |ドライバのVersionの小数点部。 |
|          |          |                    |Version 1.45 なら、 10進の45を|
|          |          |                    |格納する。                    |
|----------+----------+--------------------+------------------------------|
|124h      |word      |DRVINSTMSG          |mld.exe等によるドライバ組み込 |
|          |          |                    |み時に、タイトルとして表示する|
|          |          |                    |メッセージの存在するアドレスを|
|          |          |                    |格納するところです。メッセージ|
|          |          |                    |の最後は   '$'  で締めくくりま|
|          |          |                    |す。                          |
|----------+----------+--------------------+------------------------------|
|126h      |word      |DRVUSEMSG           |MFXDRV/DDN常駐時に、mfxddn.com|
|          |          |                    |を実行すると機能表示されます  |
|          |          |                    |が、  その機能表示のためのメッ|


                                   - 2 -                             DIL1995




MFXDDN driver technical manual                                   ver.1.15DOC


|          |          |                    |セージが存在するアドレスを、格|
|          |          |                    |納するところです。メッセージの|
|          |          |                    |最後は '$' で締めくくります。 |
|----------+----------+--------------------+------------------------------|
|128h〜    |word(?)   |DRVFUNC             |ドライバの各ファンクション実行|
|          |          |                    |先アドレスを格納するところで  |
|          |          |                    |す。音源ドライバ、タイマドライ|
|          |          |                    |バ、及びその他ドライバでファン|
|          |          |                    |クションの内容が違います。ファ|
|          |          |                    |ンクションの列びは、音源ドライ|
|          |          |                    |バはusl_drv.doc、 タイマドライ|
|          |          |                    |バはtim_drv.doc、 その他ドライ|
|          |          |                    |バはetc_drv.docに記載されてい |
|          |          |                    |る順序で書いていきます。      |
+-------------------------------------------------------------------------+


2.1  各ヘッダ情報の説明

    前述のヘッダ表の詳細な説明を行います。


2.1.1  DRVTYPE(ドライバタイプ)

      ドライバが、音源ドライバ、タイマドライバ、その他ドライバの、どの種類に
    あたるかを、ここで設定します。各ドライバの特徴について簡単に説明します。

     1. 音源ドライバ(DRVTYPE=00xxh)
          音源ドライバは、外部音源デバイス(たとえば MIDIやFM音源、 BEEP音源)
        のみを操作(発音開始、 終了、 音量制御、音色制御など)をするドライバで
        す。

     2. タイマドライバ(DRVTYPE=10xxh)
          タイマドライバは、カーネルから与えられたテンポ及びタイムベース値を
        計算し、タイマI/Fを用いて定期的に割り込みを発生させ、 カーネルに割り
        込みを供給するドライバです。

     3. その他ドライバ(DRVTYPE=20xxh)
          上の2種類のドライバ以外です。基本的に、機能を拡張する(たとえば、歌
        詞を表示したり、レベルメータや、 早送り機能を付加する)ドライバです。
        変な物としては、ちゃだんすを曲にあわせて強引に踊らせるドライバ(笑)と
        かもあります。

      上の'DRVTYPE='で示された数値を代入します。xxの部分はどんな数値でも構い
    ません。21xxh以降は将来的なreserveのため、使用しないで下さい。


2.1.2  DRVID(ドライバID)

      ドライバの名前を指定するものです。 ASCIIZ形式の固定長(15文字+NULL)で記
    述します。 ドライバIDが15文字未満の場合、 残りをスペースで埋めて15文字に
    し、最後にNULLを加えて16バイトにします。使用できる文字は特に指定しません
    が、 半角カナ文字や、漢字(Shift-JIS/JIS/EUCなど)はコードに注意して書きま
    しょう。NULL以外の文字で不都合がなければ、なんでも使用可能とします。




                                   - 3 -                             DIL1995




MFXDDN driver technical manual                                   ver.1.15DOC




2.1.3  DRVINIT(mld.exe呼び出し時初期化プログラム格納アドレス)

      mld.exe等で組み込み時に、MFXDRV/DDNは、このDRVINITのアドレスにfar call
    します。DRVINITで記述されたアドレス先のプログラムの内容は、 制御したい装
    置が正常か、あるいは使用可能か調査し、その情報を返すようにします。また、
    同時に、内部データバッファの初期化、必要ファイルの読み込みなど、演奏、及
    び動作に必要な作業を行って下さい。具体的な情報の返し方は、音源ドライバの
    場合、音源が使用可能ならば、使用可能なチャンネル数(1〜n)を、使用不可なら
    ば0をaxに入れてfar  retしてください。 また、タイマ及びその他ドライバの場
    合、 使用可能なら0以外の数、 使用不可ならば0をaxに入れてfar  retして下さ
    い。


2.1.4  DRVEND(mfxddn.com解放時実行プログラム格納アドレス)

      mfxddn /r で解放時に、MFXDRV/DDNは、このDRVENDのアドレスにfar callしま
    す。DRVENDで記述されたアドレス先のプログラムは、音源、タイマ他の使用終了
    処理などです。 ドライバが使用しているメモリは、 バッファチェインブロック
    (後述)に登録してない場合、解放する必要がありますが、ドライバ自体が存在す
    るメモリは、このプログラム実行後、自動的に解放されます。処理終了後、 far
    retを行って下さい。


2.1.5  DRVPLAY(演奏開始前実行プログラム格納アドレス)

      演奏を開始する直前に呼び出されます。 音源などの初期化を行ってret farを
    行って下さい。DOS Func.callも使用できます。


2.1.6  DRVSTOP(演奏終了後実行プログラム格納アドレス)

      演奏終了後に呼び出されます。音源などの音の消去などの処理をし、far  ret
    を行って下さい。DOS Func.callも使用できます。


2.1.7  DRVINT(演奏中割り込みプログラム格納アドレス)

      演奏中、  一定間隔で呼び出されます。  割り込み時間は、  タイムベースを
    B[Clock]、テンポをT[BPM]とすると、割り込み周期IT[s]は、

         IT=60/(T*B)

    となります。このプログラムの内容は、できるだけ軽い処理を行って下さい。重
    い処理を行うと、演奏もたりなどの影響があります。opn.xdvやssg.xdvは、ソフ
    トウェアエンベロープの音量増減処理、  及びビブラート処理などを行っていま
    す。←テンポに依存しますが^^;
      処理終了後は、 直ちにfar retしてください。なお、このプログラム内では、
    DOS Func.callは使用できません。


2.1.8  DRVCH、DRVUSECH(ドライバ使用チャンネル数)

      ここは、何も定義しないで構いません。 MFXDRV/DDNが、 自動的に書き込みま
    す。


                                   - 4 -                             DIL1995




MFXDDN driver technical manual                                   ver.1.15DOC




2.1.9  DRVVERINT(ドライババージョン番号(整数部))

      ドライバのバージョン番号x.yyの整数部を設定して下さい。たとえば、バージ
    ョンが 4.51 なら、4 を定義します。


2.1.10  DRVVERREAL(ドライババージョン番号(小数点部))

      ドライバのバージョン番号x.yyの小数点部を設定して下さい。たとえば、バー
    ジョンが 4.51 なら、51 を定義します。


2.1.11  DRVINSTMSG(ドライバ組み込み時表示メッセージ格納アドレス)

      mld.exeで、 ドライバ組み込み時に表示するタイトル文字列が存在するアドレ
    スを設定するところです。表示したいメッセージの最後には、 '$'を置いて下さ
    い。


2.1.12  DRVUSEMSG(ドライバ機能表示メッセージ格納アドレス)

      mfxddn常駐時に、mfxddn.comを実行すると、現在使用可能なドライバの機能が
    表示されます。  表示したいメッセージが存在するアドレスを設定するところで
    す。表示したいメッセージの最後には、'$'を置いて下さい。


2.1.13  DRVFUNC(機能別呼び出しアドレス)

      以下、音源ドライバ、タイマドライバ、その他ドライバにそれぞれ割り当てて
    いる機能を行うプログラムのアドレスを示します。  MFXDRV/DDNは音源制御のた
    め、 DRVFUNCに記述されたアドレスにfar callします。このアドレス先のプログ
    ラム内ではSS,SP以外のレジスタはすべて破壊しても構いません。 プログラム終
    了後は far ret で帰るようにしてください。

    それぞれのドライバに関するDRVFUNCの列びは、 音源ドライバは usl_drv.doc、
    タイマドライバは tim_drv.doc、その他ドライバは etc_drv.doc  に記載されて
    います。


2.2  ECMについて

      DRVFUNC(機能別呼び出しアドレス)の  AH=00h は、音源、タイマ及びその他ド
    ライバは、ECMとして使用します。ECMとは、Extended Control Message  の頭文
    字をとったもので、 音色定義や、DRVFUNCで定義されていない機能を付加するた
    めに用意した機能です。   MIDIでは、   このメッセージに対応するものとして
    Exclusive Messageがあります。

      音源、 タイマ及びその他ドライバは、その識別子として、DRVIDを用いていま
    す。ECMでは、このDRVIDを一切用いずに、DRVIDNUMという16bit幅の数値と、 ド
    ライバタイプの8bit幅の数値を用います。 このように、DRVIDを使用しないこと
    により、  DRVIDを一時的に変更しても、 音色定義などドライバに依存するメッ
    セージ群は正常に受け取ることができるようになっています。また、DRVIDNUMは
    固定番号で、ユーザが勝手に変更できないので、ドライバ依存のコードを作成す
    ることが出来ます。


                                   - 5 -                             DIL1995




MFXDDN driver technical manual                                   ver.1.15DOC



      es:bx   にECMID   とメッセージの存在するアドレスが入り、 ECMプログラム
    (DRVFUNC AH=00H)が呼び出されます。 ユーザまたは曲データからECMが指示され
    ると、 MFXDRV/DDNは、 登録されているすべてのドライバに、 同じECMを送りま
    す。すなわち、もし16個のドライバが組み込まれていた場合、それぞれのドライ
    バに対して同じECMで、16回呼び出されることになります。

      ECMに付加される、ECMIDは次のような形式で構成されます。

         DRVIDNUM(word)   DRVTYPE(byte)   LENGTH(word)   MESSAGE(LENGTH
         bytes)....


+-------------------------------------------------------------------------+
|address   |size      |abbreviation        |explanation                   |
|----------+----------+--------------------+------------------------------|
|es:bx     |word      |DRVIDNUM            |DRVIDNUMです。他のドライバと重|
|          |          |                    |ならない任意の数値で構いませ  |
|          |          |                    |ん。                          |
|----------+----------+--------------------+------------------------------|
|es:bx+2   |byte      |DRVTYPE             |音源ドライバは00xxxxxxB,タイマ|
|          |          |                    |ドライバは01xxxxxxB,その他ドラ|
|          |          |                    |イバは10xxxxxxB,その他は      |
|          |          |                    |11xxxxxxBです(x:任意)。       |
|----------+----------+--------------------+------------------------------|
|es:bx+3   |word      |MESSAGE Length      |メッセージの長さです。 ECMIDの|
|          |          |                    |長さ5byteは含まれません。     |
|----------+----------+--------------------+------------------------------|
|es:bx+5   |byte(?)   |Message             |ECMメッセージの本体です。     |
|          |          |                    |63Kbyteまで記述可能です。     |
+-------------------------------------------------------------------------+

    ここで、注意しなければならないことは、wordデータに関しては、HとLが反転し
    ているということです。

    DRVIDNUM=1244H DRVTYPE=30H LENGTH=4H MESSAGE=02,03,05,09H は、区切って記
    述すると、

         1244-30-0004-02-03-05-09

    ですが、binary viewerなどで覗くと、HとLが反転しているので、

         44-12-30-04-00-02-03-05-09

    となります。ECMについての説明では、 前者か後者かどっちの記述かをはっきり
    させて説明するようにして下さい。

    ECMを受け取るドライバは、以下の手順を踏んで処理してください。

     1. kernelから es:bx にECMのアドレスが入り、DRVFUNC AH=00h  が呼び出され
        ます。

     2. ドライバは     es:bx    のECMアドレスに格納されたECMデータを参照し、
        DRVIDNUM及びDRVTYPEが自分に対するのもであるか判別し、 自分に対する物
        でないなら、far ret します。



                                   - 6 -                             DIL1995




MFXDDN driver technical manual                                   ver.1.15DOC


     3. ドライバは、MESSAGEの内容を参照し、処理を行います。


    opn.xdvやssg.xdvなどでは、 MESSAGEの先頭に機能コードが格納されており、番
    号=00h が音色定義になっています。たとえば、 opn.xdvにおける音色定義のECM
    は、次のようになっています。

         0008-00-0026(長さ)-00(音色定義)-????(ﾊﾞﾝｸ)-??(音色no)-(以下
         データ)

    このECMの形式(DRVIDNUM-DRVTYPE-LENGTH-00-BANK-NO-DATA...)は、lis形式の音
    色ライブラリファイルでも使用しますので、音色定義についてはこのフォーマッ
    トに準じるようにしてください。

    音色定義は、一般的に演奏の最初に行います。そこで、MFXDRV/DDNシステムでは
    初期化用に *SOUND というトラック属性をもっています。この属性を持つトラッ
    クは、他の演奏(*COND や、OPN(0) など)より 1clock だけ早くECMを処理するこ
    とが出来ます。また、このときのみ、DOS Func.callが使用できる(それ以降は暴
    走します^^;;)ので、たとえばPCMデータをファイルから読み込んで、登録するこ
    とが可能となります。






































                                   - 7 -                             DIL1995


